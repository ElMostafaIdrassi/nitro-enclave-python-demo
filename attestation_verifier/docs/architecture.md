# Architecture

This document shows the overall architecture and the data flow of the demo

## Diagram

![Architecture](https://github.com/richardfan1126/nitro-enclave-python-demo/blob/master/attestation_verifier/docs/assets/Architecture.png)

1. The client app send a command to the server running in enclave.

1. The server app generate an encryption keypair that will be used by the SecretStore for encryption later.

1. The server app call Nitro Secure Module (NSM) of the enclave to generate an attestation document.

   This document includes the enclave measurement and the public key genereated in step 2.
   
   The document will be signed by enclave certificate.

1. The server send the attestation document to SecretStore.

1. SecretStore validite the attestation document.

   It uses CBOR Object Signing and Encryption (COSE), AWS Nitro Attestation Public Key Infrastructure and PCRs matching to make sure the request is generated by the correct enclave.

   SecretStore will then use the public key, which is embeded inside the attestation document, to encrypt the plaintext secret.

1. SecretStore send the encrypted secret to enclave server.

1. Enclave server use the private key to decrypt the secret, then send it back to client.